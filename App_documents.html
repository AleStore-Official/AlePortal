<!DOCTYPE html>
<html>
<head>
  <title>Shared Documents</title>
  <meta charset="UTF-8" />
  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js';

    const supabase = createClient(
      'https://hsyyrcbibohwvbuwxwok.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF4eHFweWd6dnd0dGp0YWV6ZWdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwNjAwMDEsImV4cCI6MjA3NjYzNjAwMX0.xPt34HCf7FmooneMFdhAkt2wDSqHFVtYrlJTL9rPAZI'
    );

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
      alert("Accesso richiesto. Effettua il login.");
      location.href = "alestore-official.github.io/AleLogin/";
    }

    window.uploadFile = async function () {
      const fileInput = document.getElementById("file");
      const file = fileInput.files[0];
      if (!file) {
        alert("Please select a file.");
        return;
      }

      await supabase.from("file_caricati").insert({
        user_id: user.id,
        nome_file: file.name,
        tipo: file.type || "unknown",
        dispositivo: navigator.userAgent,
        data: new Date().toISOString()
      });

      alert("✅ File uploaded and saved!");
      displayFiles();
    };

    window.deleteFile = async function (fileName) {
      await supabase
        .from("file_caricati")
        .delete()
        .eq("user_id", user.id)
        .eq("nome_file", fileName);

      displayFiles();
    };

    window.searchFiles = function () {
      const query = document.getElementById("searchBar").value.toLowerCase();
      const fileItems = document.querySelectorAll('.file-item');
      fileItems.forEach(item => {
        const fileName = item.querySelector('span').innerText.toLowerCase();
        item.style.display = fileName.includes(query) ? 'flex' : 'none';
      });
    };

    async function displayFiles() {
      const fileList = document.getElementById("file-list");
      fileList.innerHTML = "";

      const { data: files } = await supabase
        .from("file_caricati")
        .select("nome_file")
        .eq("user_id", user.id);

      if (!files || files.length === 0) {
        fileList.innerHTML = "<p>Nessun file caricato.</p>";
        return;
      }

      files.forEach(({ nome_file }) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `<span>${nome_file}</span><button onclick="deleteFile('${nome_file}')">Delete</button>`;
        fileList.appendChild(fileItem);
      });
    }

    displayFiles();
  </script>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="upload-container">
    <h2>Shared Documents</h2>
    <label for="file">Choose file:</label>
    <input type="file" id="file" />
    <input type="button" onclick="uploadFile()" value="Upload" />
    <input type="text" id="searchBar" class="search-bar" placeholder="Search files..." onkeyup="searchFiles()">
    <div class="file-list" id="file-list"></div>
    <footer>
      &copy; 2025 <strong>AleStore-Official</strong> — All rights reserved.
    </footer>
  </div>
  <script src="https://alestore-official.github.io/AleCAPTCHA/control.js"></script>
</body>
</html>